<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MrIndyJones: Correspondence Pro Analysis</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #161512; color: #bababa; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1000px; background: #262421; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #top-layout { display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; margin-bottom: 30px; }
        #board-wrapper { width: 400px; text-align: center; }
        #myBoard { width: 100%; border: 4px solid #3c3934; border-radius: 4px; }
        #chart-wrapper { flex: 1; min-width: 320px; background: #1a1917; padding: 15px; border-radius: 8px; height: 400px; }
        .main-btn { background: #45a049; color: white; border: none; padding: 15px 40px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; background: #1a1917; }
        th, td { padding: 12px; border-bottom: 1px solid #333; text-align: left; font-size: 0.9rem; }
        .eval-cell { font-family: monospace; font-weight: bold; }
        .positive { color: #7fa650; }
        .negative { color: #ca3431; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center;">Correspondence Analysis</h1>
    <div id="top-layout">
        <div id="board-wrapper">
            <div id="myBoard"></div>
            <button style="margin-top:10px; padding:5px 15px; cursor:pointer;" onclick="board.flip()">Flip Board</button>
        </div>
        <div id="chart-wrapper"><canvas id="evalChart"></canvas></div>
    </div>
    <div style="text-align: center;">
        <button class="main-btn" onclick="fetchAndAnalyze()">Fetch & Analyze History</button>
        <p id="status">Ready.</p>
    </div>
    <table id="move-table">
        <thead><tr><th>#</th><th>Move</th><th>Eval</th><th>FEN Snapshot</th></tr></thead>
        <tbody id="move-body"></tbody>
    </table>
</div>

<script>
    const USERNAME = 'mrindyjones';
    let engine = null;
    let evalQueue = [];
    let board, evalChart;

    // We use a lighter engine to ensure single-file stability
    async function initEngine() {
        if (engine) return;
        document.getElementById('status').innerText = "Loading engine...";
        // LOZZA is a small, UCI-compliant chess engine that works well in a single JS file
        const engineUrl = 'https://cdn.jsdelivr.net/npm/lozza@1.1.8/lozza.js';
        engine = new Worker(engineUrl);
        
        engine.onmessage = function(e) {
            const line = e.data;
            if (line.includes('score cp')) {
                const match = line.match(/score cp (-?\d+)/);
                if (match) {
                    const score = (parseInt(match[1]) / 100).toFixed(1);
                    updateCurrentMoveEval(score);
                }
            } else if (line.startsWith('bestmove')) {
                const finished = evalQueue.shift();
                analyzeNext();
            }
        };
        engine.postMessage('uci');
    }

    function updateCurrentMoveEval(score) {
        if (evalQueue.length === 0) return;
        const current = evalQueue[0];
        const cell = document.getElementById(`eval-${current.index}`);
        cell.innerText = score > 0 ? '+' + score : score;
        cell.className = 'eval-cell ' + (score < 0 ? 'negative' : 'positive');
        
        // Update Chart
        if (evalChart.data.labels.length <= current.index) {
            evalChart.data.labels.push(current.move);
            evalChart.data.datasets[0].data.push(parseFloat(score));
            evalChart.update();
        } else {
            evalChart.data.datasets[0].data[current.index] = parseFloat(score);
            evalChart.update();
        }
    }

    function analyzeNext() {
        if (evalQueue.length > 0) {
            const next = evalQueue[0];
            document.getElementById('status').innerText = `Analyzing Move ${next.index + 1}...`;
            engine.postMessage('ucinewgame');
            engine.postMessage('position fen ' + next.fen);
            engine.postMessage('go depth 10'); // Depth 10 for speed in browser
        } else {
            document.getElementById('status').innerText = "Analysis Finished.";
        }
    }

    async function fetchAndAnalyze() {
        await initEngine();
        const tbody = document.getElementById('move-body');
        tbody.innerHTML = "";
        evalQueue = [];
        evalChart.data.labels = [];
        evalChart.data.datasets[0].data = [];
        evalChart.update();

        try {
            const response = await fetch(`https://lichess.org/api/user/${USERNAME}/current-game?t=${Date.now()}`);
            if (response.status === 204) { document.getElementById('status').innerText = "No game found."; return; }
            
            const pgn = await response.text();
            const chess = new Chess();
            chess.load_pgn(pgn);
            
            board.position(chess.fen());
            board.orientation(chess.header().Black?.toLowerCase() === USERNAME ? 'black' : 'white');

            const history = chess.history();
            const temp = new Chess();
            history.forEach((move, i) => {
                temp.move(move);
                const fen = temp.fen();
                tbody.insertRow().innerHTML = `<td>${i+1}</td><td><strong>${move}</strong></td><td id="eval-${i}">...</td><td style="font-size:0.6rem; color:#555;">${fen}</td>`;
                evalQueue.push({ index: i, fen: fen, move: move });
            });
            analyzeNext();
        } catch (err) {
            document.getElementById('status').innerText = "Fetch Error. Check console.";
        }
    }

    $(document).ready(() => {
        board = Chessboard('myBoard', { 
            position: 'start', 
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' 
        });
        const ctx = document.getElementById('evalChart').getContext('2d');
        evalChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Eval', data: [], borderColor: '#7fa650', fill: true }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: -10, max: 10 } } }
        });
    });
</script>
</body>
</html>

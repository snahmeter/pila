<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MrIndyJones: Correspondence Analysis</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #161512; color: #bababa; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1000px; background: #262421; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #top-layout { display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; margin-bottom: 30px; }
        #board-wrapper { width: 400px; text-align: center; }
        #myBoard { width: 100%; border: 4px solid #3c3934; border-radius: 4px; }
        #chart-wrapper { flex: 1; min-width: 320px; background: #1a1917; padding: 15px; border-radius: 8px; height: 400px; }
        .main-btn { background: #45a049; color: white; border: none; padding: 15px 40px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.1rem; }
        .main-btn:hover { background: #52be56; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; background: #1a1917; }
        th, td { padding: 12px; border-bottom: 1px solid #333; text-align: left; font-size: 0.9rem; }
        th { color: #888; text-transform: uppercase; font-size: 0.75rem; }
        .eval-cell { font-family: monospace; font-weight: bold; font-size: 1.1rem; }
        .positive { color: #7fa650; }
        .negative { color: #ca3431; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center;">Correspondence Analysis Dashboard</h1>
    <div id="top-layout">
        <div id="board-wrapper">
            <div id="myBoard"></div>
            <button style="margin-top:10px; padding:5px 15px; cursor:pointer;" onclick="board.flip()">Flip Board Orientation</button>
        </div>
        <div id="chart-wrapper"><canvas id="evalChart"></canvas></div>
    </div>
    <div style="text-align: center;">
        <button class="main-btn" onclick="fetchAndAnalyze()">Fetch & Analyze Game</button>
        <p id="status" style="margin-top:10px; color: #888;">Ready.</p>
    </div>
    <table id="move-table">
        <thead><tr><th>#</th><th>Move</th><th>Eval</th><th>FEN Snapshot</th></tr></thead>
        <tbody id="move-body"></tbody>
    </table>
</div>

<script>
    const USERNAME = 'mrindyjones';
    let engine = null;
    let evalQueue = [];
    let board, evalChart;
    let currentEvalNum = 0;
    let currentEvalStr = "0.0";

    async function initEngine() {
        if (engine) return;
        document.getElementById('status').innerText = "Loading Stockfish engine...";
        
        try {
            // Fetching Stockfish code as text to create a local Blob worker
            const response = await fetch('https://cdn.jsdelivr.net/npm/stockfish.js@0.3.3/stockfish.js');
            const code = await response.text();
            const blob = new Blob([code], { type: 'application/javascript' });
            const workerUrl = URL.createObjectURL(blob);
            
            engine = new Worker(workerUrl);
            
            engine.onmessage = function(e) {
                // Ensure the output is handled as a string
                const line = typeof e.data === 'string' ? e.data : e.data.toString();
                
                if (line.includes('score cp')) {
                    const match = line.match(/score cp (-?\d+)/);
                    if (match) {
                        currentEvalNum = parseInt(match[1]) / 100;
                        currentEvalStr = (currentEvalNum > 0 ? '+' : '') + currentEvalNum.toFixed(1);
                    }
                } else if (line.includes('score mate')) {
                    const match = line.match(/score mate (-?\d+)/);
                    if (match) {
                        const mate = parseInt(match[1]);
                        currentEvalNum = mate > 0 ? 10 : -10;
                        currentEvalStr = 'M' + Math.abs(mate);
                    }
                }
                
                if (line.startsWith('bestmove')) {
                    const finished = evalQueue.shift();
                    const cell = document.getElementById(`eval-${finished.index}`);
                    cell.innerText = currentEvalStr;
                    cell.className = 'eval-cell ' + (currentEvalStr.startsWith('-') ? 'negative' : (currentEvalStr === '0.0' ? '' : 'positive'));
                    
                    // Update the Chart data points
                    evalChart.data.labels.push(finished.move);
                    evalChart.data.datasets[0].data.push(currentEvalNum);
                    evalChart.update();
                    
                    analyzeNext();
                }
            };
            engine.postMessage('uci');
        } catch (err) {
            console.error("Engine failed to load:", err);
            document.getElementById('status').innerText = "Engine Error. Check console.";
        }
    }

    function analyzeNext() {
        if (evalQueue.length > 0) {
            const next = evalQueue[0];
            document.getElementById('status').innerText = `Analyzing Move ${next.index + 1}...`;
            engine.postMessage('ucinewgame');
            engine.postMessage('position fen ' + next.fen);
            engine.postMessage('go depth 12'); // Fast depth for immediate feedback
        } else {
            document.getElementById('status').innerText = "Analysis Finished.";
        }
    }

    async function fetchAndAnalyze() {
        await initEngine();
        const tbody = document.getElementById('move-body');
        tbody.innerHTML = "";
        evalQueue = [];
        evalChart.data.labels = [];
        evalChart.data.datasets[0].data = [];
        evalChart.update();

        try {
            // Fetching Lichess PGN as plain text
            const response = await fetch(`https://lichess.org/api/user/${USERNAME}/current-game?t=${Date.now()}`);
            if (response.status === 204) { document.getElementById('status').innerText = "No game found."; return; }
            
            const pgn = await response.text();
            const chess = new Chess();
            chess.load_pgn(pgn);
            
            // Set board to the final state of the game
            board.position(chess.fen());
            
            // Auto-orient board based on the player's color
            const headers = chess.header();
            if (headers.Black && headers.Black.toLowerCase() === USERNAME) {
                board.orientation('black');
            } else {
                board.orientation('white');
            }

            const history = chess.history();
            const temp = new Chess();
            history.forEach((move, i) => {
                temp.move(move);
                const fen = temp.fen();
                tbody.insertRow().innerHTML = `
                    <td>${i+1}</td>
                    <td><strong>${move}</strong></td>
                    <td id="eval-${i}" class="eval-cell">...</td>
                    <td style="font-size:0.6rem; color:#555; font-family:monospace;">${fen.split(' ')[0]}...</td>
                `;
                evalQueue.push({ index: i, fen: fen, move: move });
            });
            analyzeNext();
        } catch (err) {
            document.getElementById('status').innerText = "Fetch Error. Check console.";
        }
    }

    $(document).ready(() => {
        // Initialize chessboard.js with Wikipedia theme
        board = Chessboard('myBoard', { 
            position: 'start', 
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' 
        });
        
        // Initialize Chart.js for the line graph
        const ctx = document.getElementById('evalChart').getContext('2d');
        evalChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Eval', data: [], borderColor: '#7fa650', fill: true, tension: 0.3 }] },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { y: { min: -10, max: 10, grid: { color: '#333' } }, x: { grid: { display: false } } } 
            }
        });
    });
</script>
</body>
</html>

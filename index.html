<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MrIndyJones: Correspondence Pro Analysis</title>
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #161512; color: #bababa; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1000px; background: #262421; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        #top-layout { display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; margin-bottom: 30px; }
        
        /* Board Styles */
        #board-wrapper { width: 400px; text-align: center; }
        #myBoard { width: 100%; border: 4px solid #3c3934; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        
        /* Chart Styles */
        #chart-wrapper { flex: 1; min-width: 320px; background: #1a1917; padding: 15px; border-radius: 8px; border: 1px solid #333; height: 400px; }
        
        .ctrl-btn { background: #403d39; color: #fff; border: none; padding: 10px 20px; margin: 10px 5px; border-radius: 4px; cursor: pointer; font-weight: 500; }
        .ctrl-btn:hover { background: #504d4a; }
        
        .main-btn { background: #45a049; color: white; border: none; padding: 15px 40px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 0 #2d6630; transition: all 0.1s; }
        .main-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #2d6630; }
        
        #status { margin-top: 15px; font-style: italic; color: #aaa; font-size: 0.9rem; }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 30px; background: #1a1917; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #333; text-align: left; }
        th { background: #2d2b28; color: #888; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }
        .eval-cell { font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.1rem; width: 100px; }
        .loading { color: #f1c40f; animation: pulse 1.5s infinite; }
        .positive { color: #7fa650; }
        .negative { color: #ca3431; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center; color: #fff; margin-bottom: 30px;">Correspondence Analysis Dashboard</h1>
    
    <div id="top-layout">
        <div id="board-wrapper">
            <div id="myBoard"></div>
            <button class="ctrl-btn" onclick="board.flip()">Flip Perspective</button>
        </div>

        <div id="chart-wrapper">
            <canvas id="evalChart"></canvas>
        </div>
    </div>

    <div style="text-align: center;">
        <button class="main-btn" onclick="fetchAndAnalyze()">Fetch & Analyze Current Game</button>
        <p id="status">Ready to load data for <strong>mrindyjones</strong></p>
    </div>

    <table id="move-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Move</th>
                <th>Evaluation</th>
                <th>Position (FEN)</th>
            </tr>
        </thead>
        <tbody id="move-body"></tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/stockfish@10.0.0/src/stockfish.js"></script>

<script>
    const USERNAME = 'mrindyjones';
    // Using Stockfish 10 for better browser compatibility
    const engine = new Worker('https://cdn.jsdelivr.net/npm/stockfish@10.0.0/src/stockfish.js');
    
    let evalQueue = [];
    let currentEvalStr = "0.0";
    let currentEvalNum = 0;
    let board = null;
    let evalChart = null;

    // --- Chart Setup ---
    function initChart() {
        const ctx = document.getElementById('evalChart').getContext('2d');
        evalChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Advantage',
                    data: [],
                    borderColor: '#7fa650',
                    backgroundColor: 'rgba(127, 166, 80, 0.15)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { min: -8, max: 8, grid: { color: '#333' }, ticks: { color: '#888' } },
                    x: { grid: { display: false }, ticks: { color: '#888', maxRotation: 90, minRotation: 90 } }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- Engine Communication ---
    engine.postMessage('uci');
    engine.onmessage = (e) => {
        const line = e.data;
        
        // Extract evaluation
        if (line.includes('score cp')) {
            const cpMatch = line.match(/score cp (-?\d+)/);
            if (cpMatch) {
                currentEvalNum = parseInt(cpMatch[1]) / 100;
                currentEvalStr = (currentEvalNum > 0 ? '+' : '') + currentEvalNum.toFixed(1);
            }
        } else if (line.includes('score mate')) {
            const mateMatch = line.match(/score mate (-?\d+)/);
            if (mateMatch) {
                const mate = parseInt(mateMatch[1]);
                currentEvalNum = mate > 0 ? 10 : -10; // Cap mate for graph
                currentEvalStr = 'M' + Math.abs(mate);
            }
        }

        // Wait for final calculation signal
        if (line.startsWith('bestmove')) {
            const finished = evalQueue.shift();
            
            // Update Table
            const cell = document.getElementById(`eval-${finished.index}`);
            cell.innerText = currentEvalStr;
            cell.className = 'eval-cell ' + (currentEvalStr.startsWith('-') ? 'negative' : (currentEvalStr === '0.0' ? '' : 'positive'));
            
            // Update Chart
            evalChart.data.labels.push(finished.moveName);
            evalChart.data.datasets[0].data.push(currentEvalNum);
            evalChart.update();

            analyzeNext();
        }
    };

    function analyzeNext() {
        if (evalQueue.length > 0) {
            const next = evalQueue[0];
            document.getElementById('status').innerText = `Analyzing Move ${next.index + 1}...`;
            
            engine.postMessage('ucinewgame');
            engine.postMessage('isready');
            engine.postMessage('position fen ' + next.fen);
            engine.postMessage('go depth 13');
        } else {
            document.getElementById('status').innerHTML = "<strong>Analysis Complete.</strong>";
        }
    }

    // --- Data Fetching ---
    async function fetchAndAnalyze() {
        const tbody = document.getElementById('move-body');
        tbody.innerHTML = "";
        evalQueue = [];
        evalChart.data.labels = [];
        evalChart.data.datasets[0].data = [];
        evalChart.update();

        document.getElementById('status').innerText = "Fetching PGN from Lichess...";

        try {
            // Force text/plain to avoid PGN download headers
            const response = await fetch(`https://lichess.org/api/user/${USERNAME}/current-game?t=${Date.now()}`);
            if (response.status === 204) {
                document.getElementById('status').innerText = "No active correspondence game found.";
                return;
            }

            const pgn = await response.text();
            const chess = new Chess();
            chess.load_pgn(pgn);

            // Update board and orientation
            board.position(chess.fen());
            const headers = chess.header();
            if (headers.Black && headers.Black.toLowerCase() === USERNAME) {
                board.orientation('black');
            } else {
                board.orientation('white');
            }

            // Process moves
            const history = chess.history();
            const tempChess = new Chess();
            history.forEach((move, i) => {
                tempChess.move(move);
                const fen = tempChess.fen();
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td><strong>${move}</strong></td>
                    <td id="eval-${i}" class="loading">Thinking...</td>
                    <td style="font-size:0.65rem; color:#555; font-family:monospace;">${fen.split(' ')[0]}...</td>
                `;
                evalQueue.push({ index: i, fen: fen, moveName: move });
            });

            analyzeNext();
        } catch (err) {
            console.error(err);
            document.getElementById('status').innerText = "Error: Could not reach Lichess API.";
        }
    }

    // --- Initialization ---
    $(document).ready(() => {
        board = Chessboard('myBoard', {
            position: 'start',
            draggable: false,
            // Piece theme fix for visual board
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        });
        initChart();
    });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MrIndyJones: Move History Eval</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #161512; color: #bababa; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 800px; background: #262421; padding: 20px; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #333; text-align: left; }
        th { color: #888; text-transform: uppercase; font-size: 0.8rem; }
        .eval-cell { font-weight: bold; font-family: monospace; font-size: 1.1rem; }
        .loading { color: #666; font-style: italic; }
        .positive { color: #7fa650; }
        .negative { color: #ca3431; }
        button { background: #45a049; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Game Analysis: mrindyjones</h1>
    <button onclick="fetchAndAnalyze()">Fetch & Analyze Game History</button>
    <div id="status">Ready.</div>

    <table id="move-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Move</th>
                <th>Evaluation</th>
                <th>FEN (Snapshot)</th>
            </tr>
        </thead>
        <tbody id="move-body"></tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/stockfish@16.0.0/src/stockfish.js"></script>

<script>
    const USERNAME = 'mrindyjones';
    const engine = new Worker('https://cdn.jsdelivr.net/npm/stockfish@16.0.0/src/stockfish.js');
    let evalQueue = [];

    // Engine logic to handle the queue
    engine.onmessage = (e) => {
        const msg = e.data;
        if (msg.includes('score cp') || msg.includes('score mate')) {
            let scoreStr = "0.0";
            if (msg.includes('cp')) {
                const cp = parseInt(msg.match(/score cp (-?\d+)/)[1]);
                scoreStr = (cp / 100).toFixed(1);
            } else {
                const mate = msg.match(/score mate (-?\d+)/)[1];
                scoreStr = 'M' + Math.abs(mate);
            }

            // Update the UI for the move currently being analyzed
            if (evalQueue.length > 0) {
                const currentMoveObj = evalQueue.shift();
                const cell = document.getElementById(`eval-${currentMoveObj.index}`);
                cell.innerText = scoreStr;
                cell.className = 'eval-cell ' + (parseFloat(scoreStr) >= 0 ? 'positive' : 'negative');
                
                // Process next in queue
                processQueue();
            }
        }
    };

    function processQueue() {
        if (evalQueue.length > 0) {
            const next = evalQueue[0];
            engine.postMessage('position fen ' + next.fen);
            engine.postMessage('go depth 12'); // Fast depth to get through history quickly
        } else {
            document.getElementById('status').innerText = "Analysis Complete.";
        }
    }

    async function fetchAndAnalyze() {
        const tbody = document.getElementById('move-body');
        const status = document.getElementById('status');
        tbody.innerHTML = "";
        evalQueue = [];
        status.innerText = "Fetching PGN...";

        try {
            const response = await fetch(`https://lichess.org/api/user/${USERNAME}/current-game?t=${Date.now()}`);
            if (response.status === 204) { status.innerText = "No active game."; return; }

            const pgn = await response.text();
            const game = new Chess();
            
            if (!game.load_pgn(pgn)) {
                status.innerText = "Error loading PGN.";
                return;
            }

            const history = game.history();
            const tempGame = new Chess(); // Used to step through moves
            
            // Generate rows and queue
            history.forEach((move, i) => {
                tempGame.move(move);
                const currentFen = tempGame.fen();
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${move}</td>
                    <td id="eval-${i}" class="loading">Thinking...</td>
                    <td style="font-size:0.7rem; color:#555;">${currentFen.substring(0, 30)}...</td>
                `;

                evalQueue.push({ index: i, fen: currentFen });
            });

            status.innerText = "Analyzing history...";
            processQueue();

        } catch (err) {
            status.innerText = "Error: " + err.message;
        }
    }
</script>

</body>
</html>

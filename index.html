<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MrIndyJones: Analysis Dashboard</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #161512; color: #bababa; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 900px; background: #262421; padding: 30px; border-radius: 12px; }
        #top-layout { display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; margin-bottom: 30px; }
        #board-wrapper { width: 400px; text-align: center; }
        #myBoard { width: 100%; border: 4px solid #3c3934; border-radius: 4px; }
        #chart-wrapper { flex: 1; min-width: 320px; background: #1a1917; padding: 15px; border-radius: 8px; height: 400px; }
        .main-btn { background: #45a049; color: white; border: none; padding: 15px 40px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; background: #1a1917; }
        th, td { padding: 12px; border-bottom: 1px solid #333; text-align: left; }
        .eval-cell { font-family: monospace; font-weight: bold; }
        .loading { color: #f1c40f; }
        .positive { color: #7fa650; }
        .negative { color: #ca3431; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center;">Correspondence Analysis</h1>
    <div id="top-layout">
        <div id="board-wrapper">
            <div id="myBoard"></div>
            <button style="margin-top:10px;" onclick="board.flip()">Flip Board</button>
        </div>
        <div id="chart-wrapper"><canvas id="evalChart"></canvas></div>
    </div>
    <div style="text-align: center;">
        <button class="main-btn" onclick="fetchAndAnalyze()">Analyze Game</button>
        <p id="status">Ready.</p>
    </div>
    <table>
        <thead><tr><th>#</th><th>Move</th><th>Eval</th><th>FEN Snapshot</th></tr></thead>
        <tbody id="move-body"></tbody>
    </table>
</div>

<script>
    const USERNAME = 'mrindyjones';
    let engine = null;
    let evalQueue = [];
    let currentEvalNum = 0;
    let currentEvalStr = "0.0";
    let board, evalChart;

    // --- FIX: Loading Worker via Blob to bypass Security Policy on GitHub Pages ---
    async function initEngine() {
        if (engine) return;
        try {
            const response = await fetch('https://cdn.jsdelivr.net/npm/stockfish.js@0.3.3/stockfish.js');
            const code = await response.text();
            const blob = new Blob([code], { type: 'application/javascript' });
            engine = new Worker(URL.createObjectURL(blob));
            
            engine.onmessage = (e) => {
                const line = typeof e.data === 'string' ? e.data : e.data.toString();
                if (line.includes('score cp')) {
                    const match = line.match(/score cp (-?\d+)/);
                    if (match) {
                        currentEvalNum = parseInt(match[1]) / 100;
                        currentEvalStr = (currentEvalNum > 0 ? '+' : '') + currentEvalNum.toFixed(1);
                    }
                } else if (line.includes('score mate')) {
                    const match = line.match(/score mate (-?\d+)/);
                    if (match) {
                        currentEvalNum = parseInt(match[1]) > 0 ? 10 : -10;
                        currentEvalStr = 'M' + Math.abs(parseInt(match[1]));
                    }
                }
                
                if (line.startsWith('bestmove')) {
                    const finished = evalQueue.shift();
                    const cell = document.getElementById(`eval-${finished.index}`);
                    cell.innerText = currentEvalStr;
                    cell.className = 'eval-cell ' + (currentEvalStr.startsWith('-') ? 'negative' : 'positive');
                    
                    evalChart.data.labels.push(finished.move);
                    evalChart.data.datasets[0].data.push(currentEvalNum);
                    evalChart.update();
                    analyzeNext();
                }
            };
            engine.postMessage('uci');
        } catch (e) {
            document.getElementById('status').innerText = "Engine Load Error: Check Console.";
        }
    }

    function analyzeNext() {
        if (evalQueue.length > 0) {
            const next = evalQueue[0];
            document.getElementById('status').innerText = `Analyzing Move ${next.index + 1}...`;
            engine.postMessage('ucinewgame');
            engine.postMessage('position fen ' + next.fen);
            engine.postMessage('go depth 12');
        } else {
            document.getElementById('status').innerText = "Analysis Finished.";
        }
    }

    async function fetchAndAnalyze() {
        await initEngine(); // Ensure engine is loaded first
        const tbody = document.getElementById('move-body');
        tbody.innerHTML = "";
        evalQueue = [];
        evalChart.data.labels = [];
        evalChart.data.datasets[0].data = [];
        evalChart.update();

        const response = await fetch(`https://lichess.org/api/user/${USERNAME}/current-game?t=${Date.now()}`);
        if (response.status === 204) { alert("No active game!"); return; }
        const pgn = await response.text();
        const chess = new Chess();
        chess.load_pgn(pgn);
        
        board.position(chess.fen());
        board.orientation(chess.header().Black?.toLowerCase() === USERNAME ? 'black' : 'white');

        const history = chess.history();
        const temp = new Chess();
        history.forEach((move, i) => {
            temp.move(move);
            const fen = temp.fen();
            tbody.insertRow().innerHTML = `<td>${i+1}</td><td>${move}</td><td id="eval-${i}" class="loading">...</td><td>${fen.substring(0,25)}...</td>`;
            evalQueue.push({ index: i, fen: fen, move: move });
        });
        analyzeNext();
    }

    $(document).ready(() => {
        board = Chessboard('myBoard', { 
            position: 'start', 
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png' 
        });
        const ctx = document.getElementById('evalChart').getContext('2d');
        evalChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Eval', data: [], borderColor: '#7fa650', fill: true }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: -10, max: 10 } } }
        });
    });
</script>
</body>
</html>
